# Cognitive Modules Section (reverie/backend_server/persona/cognitive_modules)

## 2. Cognitive Modules
The cognitive modules define how the generative agents (NPCs) perceive, plan, execute, reflect, and converse within the environment. Here's a breakdown of how each module works:

### 2.1 Plan Module (`plan.py`)
The Plan module manages the long-term scheduling and task decomposition for agents. It generates daily routines, hourly schedules, and specific action plans. NPCs have personal daily routines that span from waking up to completing tasks like eating, working, or socializing. Key functions include:

- `generate_wake_up_hour`: Determines when the NPC wakes up.
- `generate_first_daily_plan`: Creates a broad daily plan of actions.
- `generate_hourly_schedule`: Converts the daily plan into hour-by-hour actions (e.g., "eating breakfast," "working on a project").
- `generate_task_decomp`: Decomposes high-level tasks into smaller steps (e.g., "eat breakfast" into "prepare food, sit down, eat").
- `_determine_action`: Based on the hourly schedule, this function determines the next action for the NPC and updates the task decomposition if needed.

This module is crucial for generating a realistic simulation of daily NPC life, ensuring that each character follows a personalized schedule based on their personality and past experiences.

### 2.2 Perceive Module (`perceive.py`)
The Perceive module allows NPCs to observe their environment and other NPCs within a certain vision radius. They take note of events around them (e.g., conversations, actions) and store them in their memory. Important aspects include:

- `generate_poig_score`: Assigns an emotional poignancy score to perceived events based on their significance.
- `perceive`: The core function that gathers information about nearby tiles in the maze (environment) and logs any new events or spaces the NPC hasn't seen before. If an event or interaction is new, it gets saved to the NPC's memory.

This module defines how NPCs become aware of their surroundings, which affects their decision-making and memory. NPCs "see" things happening nearby, whether events or other NPCs, which informs their future actions.

### 2.3 Execute Module (`execute.py`)
The Execute module handles the actual carrying out of actions planned by the NPC. It processes the plan generated by the NPC and determines how they navigate the environment to complete tasks:

- `execute`: Takes the generated plan (e.g., move to a specific location or interact with another NPC) and translates it into coordinates and movements in the maze. It ensures that NPCs follow a path toward their goal while avoiding collisions with obstacles or other NPCs.

The execute module is central to how NPCs physically move through the world, determining which actions they take and how they navigate the environment to complete those tasks.

### 2.4 Converse Module (`converse.py`)
The Converse module handles interactions and dialogues between NPCs. When two NPCs encounter each other, this module generates conversation topics and dialogue based on their memory and current context:

- `generate_agent_chat`: Generates a full conversation between two NPCs based on past interactions, their relationship, and current events in the environment.
- `agent_chat_v2`: A more advanced version that allows for iterative, dynamic conversations between NPCs, factoring in emotional responses and the memory of previous chats.

This module adds depth to NPC-to-NPC interaction, enabling the generation of realistic and meaningful conversations that impact relationships and social dynamics within the simulation.

### 2.5 Reflect Module (`reflect.py`)
The Reflect module enables NPCs to think about past events and conversations. It helps them analyze and process interactions, leading to changes in their behavior or future plans:

- `run_reflect`: Runs the reflection process, generating insights from past events and storing these as thoughts in the NPC's memory.
- `generate_focal_points`: Identifies key events or interactions that the NPC should focus on during reflection.

Reflection is key for NPCs to adapt to their environment and evolve their behavior based on previous experiences. This module allows NPCs to form long-term memories and learn from their actions.

### 2.6 Retrieve Module (`retrieve.py`)
The Retrieve module helps NPCs recall relevant past events and thoughts from memory. This influences their current decisions, interactions, and conversations:

- `retrieve`: Retrieves thoughts and events from memory based on current circumstances, ensuring NPCs act with context and memory of their past.
- `cos_sim`: Measures the similarity between events in memory and current events, helping the NPC decide which memories are most relevant.

# Memory Structures Section (reverie/backend_server/persona/memory_structures)

## 3. Memory Structures
The memory system in Smallville is crucial for ensuring NPCs can form, recall, and act upon past experiences. Memory influences behavior, decision-making, and interactions, allowing NPCs to engage in dynamic and meaningful social interactions. Here's a breakdown of each memory module:

### 3.1 Associative Memory (`associative_memory.py`)
The Associative Memory module manages long-term memory for NPCs, storing events, thoughts, and conversations that NPCs encounter throughout their day. This allows NPCs to recall relevant past experiences when deciding how to act or converse with others. Key components include:

- **ConceptNode**: A data structure representing an individual memory. Each memory has attributes such as its type (event, thought, or conversation), creation time, and poignancy (emotional significance).
- **add_event, add_thought, and add_chat**: Functions that add events, thoughts, and conversations to memory. These memories are stored with associated keywords, making them retrievable later.
- **Memory Retrieval**: Memories are retrieved using functions like `retrieve_relevant_thoughts` and `retrieve_relevant_events`, allowing NPCs to access relevant past experiences during conversations or decision-making.

Associative memory is critical for creating a sense of continuity in NPC behavior. For example, if two NPCs had a conversation last week, the details of that interaction can influence their future interactions. NPCs with stronger emotional connections or significant past events will behave differently compared to those with neutral relationships.

### 3.2 Spatial Memory (`spatial_memory.py`)
The Spatial Memory module handles how NPCs remember and interact with their physical environment. NPCs can remember sectors of the world they've visited, objects within those spaces, and access permissions (e.g., certain rooms may be restricted). Important aspects include:

- **MemoryTree**: This class organizes the spatial memory as a tree structure, where each node represents a world sector, and branches represent arenas or rooms within those sectors.
- **get_str_accessible_sectors and get_str_accessible_arena_game_objects**: These functions return lists of accessible sectors and game objects in the current environment. NPCs can use this to navigate spaces and interact with objects.

Spatial memory grounds NPCs in the world, ensuring they are aware of their surroundings and can access or manipulate objects and spaces accordingly. This allows for realistic navigation and interaction within the environment.

### 3.3 Scratch Memory (`scratch.py`)
The Scratch Memory module defines the NPC's short-term memory, which tracks the current state of the NPC, including immediate tasks, current location, and ongoing interactions. Key elements include:

- **Persona Identity**: Stores core identity attributes (e.g., name, age, traits, lifestyle) as well as short-term information about current actions and goals.
- **Daily Plan**: Keeps track of the NPC’s daily schedule and short-term goals, using both long-term (broad daily plan) and decomposed (hour-by-hour) versions of the schedule.
- **Action Tracking**: Monitors the current action the NPC is performing, including its duration, description, and location (e.g., "sleeping in bedroom").
- **Reflection and Retention**: Implements functions for daily reflection, allowing the NPC to update their short-term memory and prioritize what to remember from the day's events.

Scratch memory is vital for managing immediate NPC actions and ensuring they stay on task. It also interacts with long-term associative memory to inform the NPC’s behavior based on recent experiences.

### Integrated Memory System
Together, these memory modules ensure that NPCs can:

- **Store and Recall**: NPCs store detailed information about past events, conversations, and interactions with the environment. This information is retrievable when needed, ensuring continuity in NPC behavior.
- **Plan and Navigate**: Spatial memory aids NPCs in navigating their environment, while scratch memory tracks their immediate tasks and actions. Associative memory recalls past events to inform NPCs’ decisions.
- **Interact Meaningfully**: NPCs can recall previous conversations and experiences with other NPCs, allowing them to engage in dynamic and contextually aware conversations. NPCs can also remember locations and objects in the environment, allowing them to interact more naturally with their surroundings.


This module is critical for providing continuity in NPC behavior, ensuring that characters remember important past events, conversations, or relationships and act accordingly.

# Prompt Systems Section (reverie/backend_server/persona/prompt_template)

## 4. Prompt Systems
The Prompt Systems section of Smallville is responsible for interacting with the OpenAI GPT models to generate conversations, actions, and decisions for the NPCs. These prompts allow NPCs to engage in dynamic, AI-driven interactions that are contextual and influenced by past events, relationships, and ongoing activities.

### 4.1 GPT Structure (`gpt_structure.py`)
The GPT structure module acts as the central interface for all GPT-related requests. It provides wrapper functions to handle requests to OpenAI’s GPT models (like GPT-3 and GPT-4) and processes the responses.

- **ChatGPT_single_request**: Sends a single request to the GPT-3.5-turbo model and returns the result.
- **GPT4_request**: Sends a single request to the GPT-4 model and handles any errors that may occur.
- **safe_generate_response**: A utility function that ensures the GPT-generated responses are safe and meet specific criteria, repeating the request if needed. It provides fail-safe responses if GPT fails.

This module ensures that NPCs receive appropriate responses to the prompts that govern their behavior, conversations, and actions. It also includes mechanisms to clean up and validate the responses, making sure that they fit the context of the ongoing simulation.

### 4.2 Prompt Printing (`print_prompt.py`)
The Print Prompt module handles the display and logging of prompts and their corresponding outputs, primarily for debugging and verbose output. When a prompt is run, it prints the NPC's persona, the GPT parameters used, the input prompt, and the GPT-generated output.

- **print_run_prompts**: This function takes in details like the prompt template, NPC persona, and GPT-generated output, then logs them for debugging purposes.

This module is useful for tracking the behavior of NPCs and understanding how their actions are generated based on the AI's response. It provides insights into the real-time decision-making process of NPCs within the Smallville environment.

### 4.3 Run GPT Prompts (`run_gpt_prompt.py` & `defunct_run_gpt_prompt.py`)
The Run GPT Prompts module is the core of the NPC behavior generation system. It defines various functions that generate specific behaviors for NPCs by interacting with the GPT models. Key prompt functions include:

- **run_gpt_prompt_wake_up_hour**: Determines the hour at which an NPC wakes up based on their persona's lifestyle and current conditions.
- **run_gpt_prompt_daily_plan**: Generates a broad daily plan for the NPC, including tasks like waking up, eating breakfast, and working.
- **run_gpt_prompt_task_decomp**: Decomposes a high-level task (e.g., "eat breakfast") into smaller actions (e.g., "prepare food", "sit down", "eat").
- **run_gpt_prompt_generate_hourly_schedule**: Breaks down the NPC's daily plan into an hourly schedule of actions.
- **run_gpt_prompt_create_conversation**: Generates conversation topics and dialogue between two NPCs based on their past interactions, relationship, and current state.

These functions work together to ensure that NPCs can follow realistic daily schedules, complete tasks, and engage in meaningful social interactions. They dynamically adjust NPC behaviors based on context, environment, and memory.

### How These Systems Work Together
The Prompt Systems interface directly with the cognitive and memory modules. For example:

- **Cognitive Modules** use the GPT prompts to create high-level behaviors like planning and social interaction.
- **Memory Structures** feed relevant past experiences to the GPT prompts, allowing NPCs to make decisions based on their personal history.
- **Event Systems** can trigger specific prompts (e.g., a party event might generate a conversation prompt between NPCs about the event).

